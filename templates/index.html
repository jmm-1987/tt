{% extends "base.html" %}

{% block title %}Conversaciones | Green Inbox{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Conversaciones abiertas</h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('new_conversation') }}" class="btn btn-success">Nueva conversación</a>
        <a href="{{ url_for('health_check') }}" class="btn btn-outline-secondary btn-sm">Health check</a>
    </div>
</div>

<div id="conversation-list-wrapper" class="{% if not conversations %}d-none{% endif %}">
    <div id="conversation-list" class="list-group shadow-sm">
        {% for conversation in conversations %}
            {% set last = conversation.last_message() %}
            {% set unread = conversation.unread_count() %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between" href="{{ url_for('conversation_detail', conversation_id=conversation.id) }}">
                <div>
                    <div class="fw-semibold">
                        {{ conversation.contact_name or conversation.contact_number|chat_display }}
                        {% if unread %}
                            <span class="badge rounded-pill bg-danger ms-2">{{ unread }}</span>
                        {% endif %}
                    </div>
                    <div class="text-muted small text-truncate" style="max-width: 420px;">
                        {% if last %}
                            {% if last.sender_type == "agent" %}
                                Tú:
                            {% else %}
                                Cliente:
                            {% endif %}
                            {{ last.message_text }}
                        {% else %}
                            Sin mensajes todavía
                        {% endif %}
                    </div>
                </div>
                <small class="text-muted">{{ conversation.updated_at.strftime("%d/%m/%Y %H:%M") }}</small>
            </a>
        {% endfor %}
    </div>
</div>
<div id="conversation-empty" class="alert alert-info {% if conversations %}d-none{% endif %}">
    Aún no hay conversaciones. Puedes iniciarlas con el botón <strong>Nueva conversación</strong> o esperar a que lleguen mensajes desde WhatsApp.
</div>
<script>
(function() {
    const listWrapper = document.getElementById("conversation-list-wrapper");
    const listElement = document.getElementById("conversation-list");
    const emptyAlert = document.getElementById("conversation-empty");
    if (!listElement) {
        return;
    }

    const apiUrl = "{{ url_for('api_conversations') }}";

    function renderConversations(items) {
        if (!items.length) {
            if (listWrapper) {
                listWrapper.classList.add("d-none");
            }
            if (emptyAlert) {
                emptyAlert.classList.remove("d-none");
            }
            listElement.innerHTML = "";
            return;
        }

        if (listWrapper) {
            listWrapper.classList.remove("d-none");
        }
        if (emptyAlert) {
            emptyAlert.classList.add("d-none");
        }

        listElement.innerHTML = "";

        items.forEach((item) => {
            const link = document.createElement("a");
            link.className = "list-group-item list-group-item-action d-flex justify-content-between";
            link.href = item.url;

            const left = document.createElement("div");

            const title = document.createElement("div");
            title.className = "fw-semibold";
            title.textContent = item.display_name;

            if (item.unread_count) {
                const badge = document.createElement("span");
                badge.className = "badge rounded-pill bg-danger ms-2";
                badge.textContent = item.unread_count;
                title.appendChild(badge);
            }

            const snippet = document.createElement("div");
            snippet.className = "text-muted small text-truncate";
            snippet.style.maxWidth = "420px";

            if (item.last_message_text) {
                const prefix = item.last_message_sender === "agent" ? "Tú: " : item.last_message_sender === "customer" ? "Cliente: " : "";
                snippet.textContent = prefix + item.last_message_text;
            } else {
                snippet.textContent = "Sin mensajes todavía";
            }

            left.appendChild(title);
            left.appendChild(snippet);

            const time = document.createElement("small");
            time.className = "text-muted";
            time.textContent = item.updated_at_human || "";

            link.appendChild(left);
            link.appendChild(time);

            listElement.appendChild(link);
        });
    }

    function fetchConversations() {
        fetch(apiUrl)
            .then((response) => {
                if (!response.ok) {
                    throw new Error("No fue posible actualizar la bandeja");
                }
                return response.json();
            })
            .then((payload) => {
                if (Array.isArray(payload.conversations)) {
                    renderConversations(payload.conversations);
                }
            })
            .catch((error) => console.error(error));
    }

    setInterval(fetchConversations, 5000);
})();
</script>
{% endblock %}

